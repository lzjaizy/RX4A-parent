<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Web Sql Database</title>
    <script type="text/javascript" src="jquery/jquery-1.8.0.min.js"></script>
</head>
<body>
    <script type="text/javascript">
        var contextData = [];
        var N = $('#name').val();
        var A = $('#age').val();
        var db;
        window.onload=function () {
            db = openDatabase('testDB', '1.0', '我的测试数据库', 2 * 1024 * 1024);
            setInterval(function(){
                if(navigator.onLine){
                    console.log('online');
                    if (contextData.length > 0){
                        $.ajax({
                            url: 'postData/postToSystem',
                            type: 'post',
                            data: JSON.stringify(contextData),
                            contentType: 'application/json',
                            dataType: 'json',
                            success: function (result) {
                                console.log(result);
                                if (result.code == 200) {
                                    alert('恢复成功');
                                    contextData = [];
                                } else {
                                    alert('发送失败');
                                }
                            }
                        })
                    }
                }else {
                    console.log('outline')
                }
            }, 10000);

        };

        function getDatabases() {
            console.log($('#name').val());
            console.log($('#age').val());
            var name = $('#name').val();
            var age = $('#age').val();
            db.transaction(function (context) {
                context.executeSql('CREATE TABLE IF NOT EXISTS testTable (id unique, name,age)');

                context.executeSql('INSERT INTO testTable (id, name,age) VALUES (1, ' + name + ','+ age +')');
                console.log("取出成功");
            });


            db.transaction(function (context) {

                context.executeSql(
                    "SELECT * FROM testTable ", [],

                    function (context, results) {
                        var len = results.rows.length;
                        for(var i=0;i<len;i++){
                            var temp = {};
                            console.log('取出的id: '+results.rows.item(i).id);
                            console.log('取出的name: '+results.rows.item(i).name);
                            console.log('取出的age:'+results.rows.item(i).age);
                            temp.id = results.rows.item(i).id;
                            temp.name = results.rows.item(i).name;
                            temp.age = results.rows.item(i).age;
                            contextData.push(temp);
                            // console.log('contextData:'+contextData.push(temp));
                        }
                    },
                    function (context, error) {
                        alert('查询失败: ' );
                        console.log(error);
                    }
                );

            });
            }

        function postToSystem() {
            var temp = {};
            var name = $('#name').val();
            var age = $('#age').val();
            temp.id = 1;
            temp.name = name;
            temp.age = age;
            contextData.push(temp);
            if(navigator.onLine){
                $.ajax({
                    url: 'postData/postToSystem',
                    type: 'post',
                    data: JSON.stringify(contextData),
                    contentType: 'application/json',
                    dataType: 'json',
                    success: function (result) {
                        console.log(result);
                        if (result.code == 200) {
                            alert('发送成功');
                            contextData = [];
                        } else {
                            alert('发送失败');
                        }
                    }
                })
            }else{
                db.transaction(function (context) {
                    context.executeSql('CREATE TABLE IF NOT EXISTS testTable (id unique, name,age)');

                    context.executeSql('INSERT INTO testTable (id, name,age) VALUES (1, ' + name + ','+ age +')');
                });
            }
            console.log(contextData);

        }


    </script>
<div>
   <input type="text" name="userName" id="name"></td>
   <input type="text" name="userAge" id="age">

    <button onclick="getDatabases()"> 取出数据 </button>
    <button onclick="postToSystem()"> 发送后台 </button>
    <button onclick="recoveryData()"> 恢复数据 </button>
</div>

</body>
</html>